/**\n * ДВИГАТЕЛЬ ВАЛИДАЦИИ РЕЗУЛЬТАТОВ\n * \"Лестница союза\"\n *\n * 4-уровневая система проверки достоверности:\n * 1. Анализ скорости ответов - быстрые ответы на чувствительные вопросы\n * 2. Обнаружение противоречий - несоответствия между похожими вопросами\n * 3. Оценка когерентности - внутренняя логическая последовательность\n * 4. Обнаружение духовного байпаса - высокие уровни без практической основы\n */\n\nimport { UserAnswer, ValidationMetrics, UnionLevel } from './types';\nimport { QUESTIONS } from './questions-database';\n\n// ============================================================================\n// ТИПЫ\n// ============================================================================\n\nexport interface ValidationResult {\n  metrics: ValidationMetrics;\n  warnings: ValidationWarning[];\n  isReliable: boolean; // Стоит ли доверять результатам\n  recommendations: string[]; // Что можно улучшить\n}\n\nexport interface ValidationWarning {\n  type: 'speed' | 'contradiction' | 'incoherence' | 'spiritual-bypass' | 'pattern';\n  severity: 'low' | 'medium' | 'high';\n  message: string;\n  questionIds?: string[]; // Какие вопросы связаны\n}\n\n// ============================================================================\n// АНАЛИЗ СКОРОСТИ ОТВЕТОВ\n// ============================================================================\n\n/**\n * Проанализировать скорость ответов\n * Быстрые ответы (< 1 сек) на чувствительные вопросы могут указывать на\n * желательность социального имиджа или поверхностное отношение\n */\nfunction analyzeResponseSpeed(\n  answers: UserAnswer[]\n): {\n  anomaly: boolean;\n  averageTime: number;\n  flags: ValidationWarning[];\n  socialDesirabilityScore: number; // 0-1\n} {\n  const flags: ValidationWarning[] = [];\n\n  // Определить чувствительные вопросы\n  const sensitiveQuestions = [\n    'level-detail-emotion-008',\n    'level-detail-jealousy-009',\n    'validation-contradiction-026',\n    'validation-spiritual-bypass-027',\n    'validation-honesty-029',\n  ];\n\n  // Рассчитать среднее время ответа\n  const avgTime =\n    answers.reduce((sum, a) => sum + a.responseTime, 0) / answers.length;\n\n  // Найти очень быстрые ответы (< 1 сек)\n  const fastAnswers = answers.filter((a) => a.responseTime < 1000);\n  const fastSensitiveAnswers = fastAnswers.filter((a) =>\n    sensitiveQuestions.includes(a.questionId)\n  );\n\n  let socialDesirabilityScore = 0;\n\n  if (fastSensitiveAnswers.length > 2) {\n    flags.push({\n      type: 'speed',\n      severity: 'high',\n      message: `Обнаружено ${fastSensitiveAnswers.length} очень быстрых ответов на чувствительные вопросы. Это может указывать на желание выглядеть лучше.`,\n      questionIds: fastSensitiveAnswers.map((a) => a.questionId),\n    });\n    socialDesirabilityScore = Math.min(1, fastSensitiveAnswers.length / 5);\n  }\n\n  // Очень быстрые ответы вообще (< 500мс) - поверхностное отношение\n  if (fastAnswers.length > answers.length * 0.3) {\n    flags.push({\n      type: 'speed',\n      severity: 'medium',\n      message: 'Более 30% ответов даны очень быстро (< 500мс). Возможно, недостаточно глубокое размышление.',\n    });\n    socialDesirabilityScore += 0.2;\n  }\n\n  return {\n    anomaly: flags.length > 0,\n    averageTime: Math.round(avgTime),\n    flags,\n    socialDesirabilityScore: Math.min(1, socialDesirabilityScore),\n  };\n}\n\n// ============================================================================\n// ОБНАРУЖЕНИЕ ПРОТИВОРЕЧИЙ\n// ============================================================================\n\n/**\n * Обнаружить противоречия между похожими вопросами\n * Например, говорит о высокой духовности, но критикует партнера\n */\nfunction detectContradictions(\n  answers: UserAnswer[]\n): {\n  contradictions: ValidationWarning[];\n  contradictionFlags: string[];\n} {\n  const contradictions: ValidationWarning[] = [];\n  const contradictionFlags: string[] = [];\n\n  // Создать карту ответов для удобства\n  const answerMap = new Map<string, UserAnswer>();\n  answers.forEach((a) => answerMap.set(a.questionId, a));\n\n  // ПРАВИЛО 1: Если высокая любовь но много критики\n  // Вопрос 'zone-choice-005' vs 'level-detail-influence-021'\n  const q1 = answerMap.get('zone-choice-005');\n  const q2 = answerMap.get('level-detail-influence-021');\n\n  if (q1 && q2) {\n    if (q1.selectedLevel >= 8 && q2.selectedLevel <= 4) {\n      contradictions.push({\n        type: 'contradiction',\n        severity: 'high',\n        message:\n          'Противоречие: говорите, что выбрали партнера из любви (высокий уровень), но постоянно пытаетесь его переделать (низкий уровень). Это признак условной любви.',\n        questionIds: [q1.questionId, q2.questionId],\n      });\n      contradictionFlags.push('conditional-love');\n    }\n  }\n\n  // ПРАВИЛО 2: Если говорит о полной аутентичности, но боится показать слабости\n  // 'level-detail-authenticity-011' vs 'validation-honesty-029'\n  const q3 = answerMap.get('level-detail-authenticity-011');\n  const q4 = answerMap.get('validation-honesty-029');\n\n  if (q3 && q4) {\n    if (q3.selectedLevel >= 8 && q4.selectedLevel <= 5) {\n      contradictions.push({\n        type: 'contradiction',\n        severity: 'high',\n        message:\n          'Противоречие: утверждаете полную аутентичность, но на чувствительных вопросах выбираете социально желательные ответы. Реальная уязвимость ниже заявленной.',\n        questionIds: [q3.questionId, q4.questionId],\n      });\n      contradictionFlags.push('inauthentic-facade');\n    }\n  }\n\n  // ПРАВИЛО 3: Если говорит о росте вместе, но партнер не меняется\n  // 'zone-growth-003' vs 'validation-change-028'\n  const q5 = answerMap.get('zone-growth-003');\n  const q6 = answerMap.get('validation-change-028');\n\n  if (q5 && q6) {\n    if (q5.selectedLevel >= 9 && q6.selectedLevel <= 2) {\n      contradictions.push({\n        type: 'contradiction',\n        severity: 'medium',\n        message:\n          'Противоречие: утверждаете взаимный рост, но ничего не менялось за год. Возможно, идеализация или отрицание застоя.',\n        questionIds: [q5.questionId, q6.questionId],\n      });\n      contradictionFlags.push('stagnation-denial');\n    }\n  }\n\n  // ПРАВИЛО 4: Если говорит о высокой духовности, но отношения нестабильны\n  // 'validation-spiritual-bypass-027' vs 'zone-conflict-001'\n  const q7 = answerMap.get('validation-spiritual-bypass-027');\n  const q8 = answerMap.get('zone-conflict-001');\n\n  if (q7 && q8) {\n    if (q7.selectedLevel >= 10 && q8.selectedLevel <= 4) {\n      contradictions.push({\n        type: 'contradiction',\n        severity: 'high',\n        message:\n          'Противоречие: видите отношения как очень духовные, но при конфликте используете уход или защиту. Возможен духовный байпас - использование духовности чтобы избежать реальной работы.',\n        questionIds: [q7.questionId, q8.questionId],\n      });\n      contradictionFlags.push('spiritual-bypass');\n    }\n  }\n\n  // ПРАВИЛО 5: Если полная свобода, но ревность\n  // 'level-detail-freedom-016' vs 'level-detail-jealousy-009'\n  const q9 = answerMap.get('level-detail-freedom-016');\n  const q10 = answerMap.get('level-detail-jealousy-009');\n\n  if (q9 && q10) {\n    if (q9.selectedLevel >= 9 && q10.selectedLevel <= 5) {\n      contradictions.push({\n        type: 'contradiction',\n        severity: 'medium',\n        message:\n          'Противоречие: утверждаете полную свободу и доверие, но ревность вас не отпускает. Это признак незавершенной работы над привязанностью.',\n        questionIds: [q9.questionId, q10.questionId],\n      });\n      contradictionFlags.push('insecure-freedom');\n    }\n  }\n\n  return {\n    contradictions,\n    contradictionFlags,\n  };\n}\n\n// ============================================================================\n// ОЦЕНКА КОГЕРЕНТНОСТИ\n// ============================================================================\n\n/**\n * Рассчитать когерентность (внутреннюю логическую последовательность)\n * На основе согласованности ответов в одной категории\n */\nfunction calculateCoherence(\n  answers: UserAnswer[]\n): {\n  coherenceScore: number; // 0-100\n  categoryScores: Map<string, number>; // Когерентность по категориям\n  flags: ValidationWarning[];\n} {\n  const flags: ValidationWarning[] = [];\n\n  // Сгруппировать ответы по категориям\n  const questionMap = new Map();\n  QUESTIONS.forEach((q) => questionMap.set(q.id, q));\n\n  const categoryLevels = new Map<string, UnionLevel[]>();\n\n  answers.forEach((answer) => {\n    const question = questionMap.get(answer.questionId);\n    if (!question) return;\n\n    if (!categoryLevels.has(question.category)) {\n      categoryLevels.set(question.category, []);\n    }\n    categoryLevels.get(question.category).push(answer.selectedLevel);\n  });\n\n  // Рассчитать стандартное отклонение для каждой категории\n  const categoryScores = new Map<string, number>();\n  let totalCoherence = 0;\n  let categoryCount = 0;\n\n  categoryLevels.forEach((levels, category) => {\n    if (levels.length < 2) {\n      categoryScores.set(category, 100);\n      return;\n    }\n\n    // Рассчитать среднее и стандартное отклонение\n    const avg = levels.reduce((a, b) => a + b, 0) / levels.length;\n    const variance =\n      levels.reduce((sum, level) => sum + Math.pow(level - avg, 2), 0) /\n      levels.length;\n    const stdDev = Math.sqrt(variance);\n\n    // Рассчитать когерентность (0-100)\n    // Низкое стандартное отклонение = высокая когерентность\n    const coherence = Math.max(0, 100 - stdDev * 20); // Нормализовать\n\n    categoryScores.set(category, Math.round(coherence));\n    totalCoherence += coherence;\n    categoryCount++;\n  });\n\n  const overallCoherence = categoryCount > 0 ? totalCoherence / categoryCount : 50;\n\n  // Флаг если когерентность низкая (< 40%)\n  if (overallCoherence < 40) {\n    flags.push({\n      type: 'incoherence',\n      severity: 'high',\n      message:\n        'Низкая когерентность: ваши ответы в одной категории сильно разнятся. Возможно, непредсказуемо, как вы себя ведете, или трудно определить стабильный уровень.',\n    });\n  }\n\n  return {\n    coherenceScore: Math.round(overallCoherence),\n    categoryScores,\n    flags,\n  };\n}\n\n// ============================================================================\n// ОБНАРУЖЕНИЕ ДУХОВНОГО БАЙПАСА\n// ============================================================================\n\n/**\n * Обнаружить признаки духовного байпаса\n * Использование духовности чтобы избежать реальной работы над отношениями\n */\nfunction detectSpiritualBypass(\n  answers: UserAnswer[]\n): {\n  spiritualBypassScore: number; // 0-1\n  flags: ValidationWarning[];\n} {\n  const flags: ValidationWarning[] = [];\n\n  // Создать карту ответов\n  const answerMap = new Map<string, UserAnswer>();\n  answers.forEach((a) => answerMap.set(a.questionId, a));\n\n  let bypassIndicators = 0;\n  const totalIndicators = 5;\n\n  // ИНДИКАТОР 1: Высокий уровень на уровне 11-12 + низкий практический уровень на конфликтах\n  const q1 = answerMap.get('validation-spiritual-bypass-027');\n  if (q1 && q1.selectedLevel >= 10) {\n    const q2 = answerMap.get('zone-conflict-001');\n    if (q2 && q2.selectedLevel <= 4) {\n      bypassIndicators++;\n      flags.push({\n        type: 'spiritual-bypass',\n        severity: 'high',\n        message:\n          'Возможен духовный байпас: видите отношения как священные, но на практике избегаете конфликтов или защищаетесь. Духовность может использоваться чтобы избежать реальной работы.',\n      });\n    }\n  }\n\n  // ИНДИКАТОР 2: Очень высокая оценка своей духовности, но низкая оценка партнера\n  const q3 = answerMap.get('validation-awareness-030');\n  const q4 = answerMap.get('validation-spiritual-bypass-027');\n\n  if (q4 && q4.selectedLevel >= 10) {\n    if (q3 && q3.selectedLevel <= 7) {\n      bypassIndicators++;\n      flags.push({\n        type: 'spiritual-bypass',\n        severity: 'medium',\n        message:\n          'Возможен духовный байпас: вы видите себя как духовного, но партнер не соответствует вашим идеалам. Это может быть духовным нарциссизмом.',\n      });\n    }\n  }\n\n  // ИНДИКАТОР 3: Жертвование любыми мечтами + высокая духовность\n  const q5 = answerMap.get('level-detail-sacrifice-018');\n  const q6 = answerMap.get('validation-spiritual-bypass-027');\n\n  if (q6 && q6.selectedLevel >= 10) {\n    if (q5 && q5.selectedLevel >= 2 && q5.selectedLevel <= 4) {\n      bypassIndicators++;\n      flags.push({\n        type: 'spiritual-bypass',\n        severity: 'medium',\n        message:\n          'Возможен духовный байпас: видите отношения как служение, но при этом отказываетесь от своих мечт. Истинное служение не требует полного самопожертвования.',\n      });\n    }\n  }\n\n  // ИНДИКАТОР 4: Все хорошо в отношениях + очень высокий уровень\n  const q7 = answerMap.get('validation-change-028');\n  const q8 = answerMap.get('validation-spiritual-bypass-027');\n\n  if (q8 && q8.selectedLevel >= 11) {\n    // Проверить все ли другие уровни были низкие\n    const avgLevel =\n      answers.reduce((sum, a) => sum + a.selectedLevel, 0) / answers.length;\n    if (avgLevel <= 7) {\n      bypassIndicators++;\n      flags.push({\n        type: 'spiritual-bypass',\n        severity: 'high',\n        message:\n          'Противоречие: утверждаете, что отношения на уровне Духовного союза, но в остальном ответе показываете более низкие уровни зрелости. Это может быть идеализация или духовный байпас.',\n      });\n    }\n  }\n\n  // ИНДИКАТОР 5: Заявляет о духовности, но на валидационных вопросах выбирает социально желательные ответы\n  const q9 = answerMap.get('validation-spiritual-bypass-027');\n  const q10 = answerMap.get('validation-honesty-029');\n\n  if (q9 && q9.selectedLevel >= 11 && q10 && q10.selectedLevel <= 5) {\n    bypassIndicators++;\n    flags.push({\n      type: 'spiritual-bypass',\n      severity: 'high',\n      message:\n        'Возможен духовный байпас: заявляете о высокой духовности, но на валидационных вопросах выбираете социально желательные ответы. Истинная духовность предполагает полную честность.',\n    });\n  }\n\n  const spiritualBypassScore = bypassIndicators / totalIndicators;\n\n  return {\n    spiritualBypassScore,\n    flags,\n  };\n}\n\n// ============================================================================\n// ПУБЛИЧНЫЙ API\n// ============================================================================\n\n/**\n * Провести полную валидацию результатов тестирования\n */\nexport function validateTestResults(\n  answers: UserAnswer[]\n): ValidationResult {\n  const warnings: ValidationWarning[] = [];\n\n  // Слой 1: Анализ скорости ответов\n  const speedAnalysis = analyzeResponseSpeed(answers);\n  warnings.push(...speedAnalysis.flags);\n\n  // Слой 2: Обнаружение противоречий\n  const contradictionAnalysis = detectContradictions(answers);\n  warnings.push(...contradictionAnalysis.contradictions);\n\n  // Слой 3: Оценка когерентности\n  const coherenceAnalysis = calculateCoherence(answers);\n  warnings.push(...coherenceAnalysis.flags);\n\n  // Слой 4: Обнаружение духовного байпаса\n  const bypassAnalysis = detectSpiritualBypass(answers);\n  warnings.push(...bypassAnalysis.flags);\n\n  // Рассчитать общий score надежности\n  const reliabilityScore = Math.max(\n    0,\n    100 -\n      speedAnalysis.socialDesirabilityScore * 30 -\n      (100 - coherenceAnalysis.coherenceScore) * 0.3 -\n      bypassAnalysis.spiritualBypassScore * 20 -\n      contradictionAnalysis.contradictions.length * 10\n  );\n\n  // Определить уровень надежности\n  let reliability: 'high' | 'medium' | 'low';\n  if (reliabilityScore >= 70) {\n    reliability = 'high';\n  } else if (reliabilityScore >= 50) {\n    reliability = 'medium';\n  } else {\n    reliability = 'low';\n  }\n\n  // Сгенерировать рекомендации\n  const recommendations: string[] = [];\n\n  if (speedAnalysis.anomaly) {\n    recommendations.push(\n      'Старайтесь дольше размышлять перед ответом, особенно на сложные вопросы'\n    );\n  }\n\n  if (contradictionAnalysis.contradictions.length > 0) {\n    recommendations.push(\n      'Обратите внимание на обнаруженные противоречия - они могут скрывать нерешённые психологические конфликты'\n    );\n  }\n\n  if (coherenceAnalysis.coherenceScore < 50) {\n    recommendations.push(\n      'Ваши ответы в одной категории сильно варьируются - может быть полезно работать над стабильностью поведения'\n    );\n  }\n\n  if (bypassAnalysis.spiritualBypassScore > 0.5) {\n    recommendations.push(\n      'Обратите внимание на возможный духовный байпас - баланс между идеалом и практикой очень важен'\n    );\n  }\n\n  const metrics: ValidationMetrics = {\n    responseSpeedAnomaly: speedAnalysis.anomaly,\n    averageResponseTime: speedAnalysis.averageTime,\n    socialDesirabilityScore: speedAnalysis.socialDesirabilityScore,\n    coherenceScore: coherenceAnalysis.coherenceScore,\n    contradictionFlags: contradictionAnalysis.contradictionFlags,\n    spiritualBypassScore: bypassAnalysis.spiritualBypassScore,\n    reliabilityScore: Math.round(reliabilityScore),\n    reliability,\n  };\n\n  return {\n    metrics,\n    warnings,\n    isReliable: reliability !== 'low',\n    recommendations,\n  };\n}\n\n/**\n * Получить краткую оценку надежности\n */\nexport function getReliabilityMessage(\n  metrics: ValidationMetrics\n): string {\n  if (metrics.reliability === 'high') {\n    return 'Результаты теста выглядят надежными и достоверными';\n  } else if (metrics.reliability === 'medium') {\n    return 'Результаты частично надежны, но рекомендуется обратить внимание на обнаруженные проблемы';\n  } else {\n    return 'Результаты низкой надежности - возможны искажения из-за социальной желательности, противоречий или духовного байпаса';\n  }\n}\n"
